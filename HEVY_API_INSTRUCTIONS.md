# Hevy API Integration Instructions

## Overview

The Hevy API provides comprehensive access to workout data, exercise templates, and user profiles. Based on the official [Hevy API documentation](https://api.hevyapp.com/docs/#/Workouts/get_v1_workouts), this guide covers all available endpoints and their usage for the Hevier workout intelligence app.

## Base URL

```
https://api.hevyapp.com/v1
```

## Authentication

All API requests require an API key passed in the header:

```
Headers:
  api-key: YOUR_HEVY_API_TOKEN
  Content-Type: application/json
```

### Getting Your API Token

1. Log into your Hevy account
2. Navigate to Settings → Developer/API section  
3. Generate or copy your API token
4. Store securely in your `.env.local` file:
   ```
   HEVY_API_TOKEN=your_token_here
   ```

## Option 1: Using Official Hevy Client (Recommended)

The [hevy-api-client](https://github.com/kuhiga/hevy-api-client) provides a TypeScript/Node.js wrapper that simplifies API interactions.

### Installation

```bash
npm install hevy-client
```

### Usage Example

```javascript
import { HevyClient } from "hevy-client";

// Initialize the client with your API key
const client = new HevyClient(process.env.HEVY_API_TOKEN);

// Fetch all workouts
const workouts = await client.getWorkouts();

// Create a new workout
const newWorkout = await client.createWorkout({
  workout: {
    title: "Morning Workout 💪",
    description: "Push day",
    start_time: new Date().toISOString(),
    end_time: new Date().toISOString(),
    is_private: false,
    exercises: [
      {
        exercise_template_id: "05293BCA",
        sets: [
          {
            type: "normal",
            weight_kg: 100,
            reps: 10,
          },
        ],
      },
    ],
  },
});
```

## Option 2: Direct API Endpoints

### 1. Workouts Endpoints

#### GET `/v1/workouts`
**Purpose**: Retrieve user's workout history with optional filters.

**Parameters:**
- `limit` (integer, optional): Number of workouts to return (default: 50, max: 100)
- `offset` (integer, optional): Pagination offset (default: 0)
- `start_date` (string, optional): ISO date string for earliest workout
- `end_date` (string, optional): ISO date string for latest workout
- `exercise_template_id` (string, optional): Filter by specific exercise

**Example Request:**
```bash
curl -X GET "https://api.hevyapp.com/v1/workouts?limit=10&start_date=2024-01-01T00:00:00Z" \
  -H "api-key: YOUR_TOKEN"
```

**Response Structure:**
```json
{
  "workouts": [
    {
      "id": "workout-uuid",
      "title": "Push Day A", 
      "description": "Upper body push workout",
      "start_time": "2024-01-15T10:00:00Z",
      "end_time": "2024-01-15T11:30:00Z",
      "is_private": false,
      "exercises": [
        {
          "id": "exercise-uuid",
          "title": "Bench Press",
          "notes": "Felt strong today",
          "exercise_template_id": "template-uuid",
          "superset_id": null,
          "sets": [
            {
              "index": 0,
              "type": "normal", // "normal", "warmup", "failure", "drop"
              "weight_kg": 80,
              "reps": 8,
              "distance_meters": null,
              "duration_seconds": null,
              "rpe": 7 // Rate of Perceived Exertion (1-10)
            }
          ]
        }
      ]
    }
  ],
  "page_info": {
    "has_next_page": true,
    "has_previous_page": false,
    "start_cursor": "cursor-string",
    "end_cursor": "cursor-string"
  }
}
```

#### GET `/v1/workouts/{workout_id}`
**Purpose**: Retrieve a specific workout by ID (used by webhook processing).

**Example Request:**
```bash
curl -X GET "https://api.hevyapp.com/v1/workouts/f1085cdb-32b2-4003-967d-53a3af8eaecb" \
  -H "api-key: YOUR_TOKEN"
```

#### POST `/v1/workouts`
**Purpose**: Create a new workout programmatically.

**Request Body:**
```json
{
  "title": "My Custom Workout",
  "description": "Generated by Hevier",
  "start_time": "2024-01-15T10:00:00Z",
  "end_time": "2024-01-15T11:30:00Z", 
  "is_private": false,
  "exercises": [
    {
      "exercise_template_id": "template-uuid",
      "notes": "Focus on form",
      "sets": [
        {
          "type": "normal",
          "weight_kg": 70,
          "reps": 10,
          "rpe": 8
        }
      ]
    }
  ]
}
```

### 2. Exercise Templates Endpoints

#### GET `/v1/exercise_templates`
**Purpose**: Retrieve available exercise templates for workout planning.

**Parameters:**
- `limit` (integer, optional): Number of templates to return
- `offset` (integer, optional): Pagination offset
- `search` (string, optional): Search exercise names
- `muscle_group` (string, optional): Filter by muscle group

**Example Request:**
```bash
curl -X GET "https://api.hevyapp.com/v1/exercise_templates?search=bench%20press&limit=20" \
  -H "api-key: YOUR_TOKEN"
```

**Response Structure:**
```json
{
  "exercise_templates": [
    {
      "id": "template-uuid",
      "title": "Bench Press",
      "muscle_groups": ["chest", "shoulders", "triceps"],
      "equipment": ["barbell", "bench"],
      "instructions": [
        "Lie flat on bench with eyes under the bar",
        "Grip bar with hands slightly wider than shoulders", 
        "Lower bar to chest with control",
        "Press bar up explosively"
      ],
      "type": "strength", // "strength", "cardio", "stretching"
      "difficulty": "intermediate"
    }
  ],
  "page_info": {
    "has_next_page": false,
    "has_previous_page": false
  }
}
```

#### GET `/v1/exercise_templates/{template_id}`
**Purpose**: Get detailed information for a specific exercise template.

### 3. User Profile Endpoints

#### GET `/v1/user/profile`
**Purpose**: Retrieve current user's profile and preferences.

**Example Request:**
```bash
curl -X GET "https://api.hevyapp.com/v1/user/profile" \
  -H "api-key: YOUR_TOKEN"
```

**Response Structure:**
```json
{
  "id": "user-uuid",
  "username": "fitness_enthusiast",
  "email": "user@example.com",
  "created_at": "2023-01-01T00:00:00Z",
  "preferences": {
    "units": "metric", // "metric" or "imperial"
    "default_rest_timer": 120, // seconds
    "privacy_level": "public"
  }
}
```

### 4. Routines Endpoints

#### GET `/v1/routines`
**Purpose**: Get user's saved workout routines/templates.

#### GET `/v1/routines/{routine_id}`
**Purpose**: Get details for a specific routine.

### 5. Webhook Endpoints

#### POST `/v1/webhooks`
**Purpose**: Register a webhook URL for real-time workout notifications.

**Request Body:**
```json
{
  "url": "https://your-app.com/api/webhook/hevy",
  "events": ["workout.created", "workout.updated"],
  "description": "Hevier app webhook"
}
```

**Response:**
```json
{
  "id": "webhook-uuid",
  "url": "https://your-app.com/api/webhook/hevy", 
  "events": ["workout.created"],
  "active": true,
  "created_at": "2024-01-15T10:00:00Z"
}
```

#### GET `/v1/webhooks`
**Purpose**: List all registered webhooks for the user.

#### DELETE `/v1/webhooks/{webhook_id}`
**Purpose**: Remove a webhook subscription.

## Implementation Examples for Hevier

### 1. Fetch Recent Workouts (Hevier's Core Function)

```javascript
// Using hevy-client
import { HevyClient } from "hevy-client";

const client = new HevyClient(process.env.HEVY_API_TOKEN);

async function getRecentWorkouts(days = 7) {
  const startDate = new Date();
  startDate.setDate(startDate.getDate() - days);
  
  // Get workouts from the last N days
  const workouts = await client.getWorkouts({
    start_date: startDate.toISOString(),
    limit: 100
  });
  
  return workouts;
}

// Direct API approach  
async function getRecentWorkoutsAPI(days = 7) {
  const startDate = new Date();
  startDate.setDate(startDate.getDate() - days);
  
  const response = await fetch(`https://api.hevyapp.com/v1/workouts?start_date=${startDate.toISOString()}&limit=100`, {
    headers: {
      'api-key': process.env.HEVY_API_TOKEN
    }
  });
  
  const data = await response.json();
  return data.workouts;
}
```

### 2. Set Up Real-time Webhook (Hevier's Live Updates)

```javascript
async function setupHevierWebhook() {
  const webhookUrl = `${process.env.NEXT_PUBLIC_BASE_URL}/api/webhook/hevy`;
  
  const response = await fetch('https://api.hevyapp.com/v1/webhooks', {
    method: 'POST',
    headers: {
      'api-key': process.env.HEVY_API_TOKEN,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      url: webhookUrl,
      events: ['workout.created'],
      description: 'Hevier real-time workout analysis'
    })
  });
  
  if (!response.ok) {
    throw new Error(`Webhook setup failed: ${response.statusText}`);
  }
  
  return response.json();
}
```

### 3. Exercise Template Search (For Suggestions)

```javascript
// Find exercise templates for workout suggestions
async function findExerciseTemplates(searchTerms) {
  const client = new HevyClient(process.env.HEVY_API_TOKEN);
  
  const templates = [];
  
  for (const term of searchTerms) {
    try {
      const results = await client.getExerciseTemplates({
        search: term,
        limit: 10
      });
      templates.push(...results.exercise_templates);
    } catch (error) {
      console.warn(`Failed to search for "${term}":`, error.message);
    }
  }
  
  // Remove duplicates
  const uniqueTemplates = templates.filter((template, index, self) => 
    self.findIndex(t => t.id === template.id) === index
  );
  
  return uniqueTemplates;
}

// Usage in Hevier
const searchTerms = ['bench press', 'squat', 'deadlift', 'pull up'];
const templates = await findExerciseTemplates(searchTerms);
```

### 4. Workout Creation (Future Feature)

```javascript
// Create a suggested workout in Hevy
async function createSuggestedWorkout(suggestion) {
  const client = new HevyClient(process.env.HEVY_API_TOKEN);
  
  const workout = {
    title: `Hevier: ${suggestion.workoutType} Day`,
    description: `AI-generated ${suggestion.workoutType} workout based on your volume deficits`,
    start_time: new Date().toISOString(),
    exercises: suggestion.exercises.map(exercise => ({
      exercise_template_id: exercise.templateId, // Would need to map from our reference
      notes: exercise.reason,
      sets: Array(exercise.suggestedSets).fill({
        type: 'normal',
        reps: exercise.suggestedReps.min, 
        weight_kg: null // User fills in
      })
    }))
  };
  
  return client.createWorkout({ workout });
}
```

## Error Handling & Best Practices

### Rate Limiting
- **Limit**: 1000 requests/hour per API key
- **Burst**: 50 requests/minute
- **Headers**: `X-RateLimit-*` in responses

### Error Response Format
```json
{
  "error": {
    "code": "INVALID_REQUEST",
    "message": "The request is invalid",
    "details": {
      "field": "start_date", 
      "issue": "Invalid date format"
    }
  }
}
```

### Robust Error Handling
```javascript
class HevyAPIService {
  constructor(apiKey) {
    this.client = new HevyClient(apiKey);
  }
  
  async getWorkoutsWithRetry(options, maxRetries = 3) {
    for (let attempt = 1; attempt <= maxRetries; attempt++) {
      try {
        return await this.client.getWorkouts(options);
      } catch (error) {
        console.warn(`Attempt ${attempt} failed:`, error.message);
        
        if (attempt === maxRetries) {
          throw error;
        }
        
        // Exponential backoff
        const delay = Math.pow(2, attempt) * 1000;
        await new Promise(resolve => setTimeout(resolve, delay));
      }
    }
  }
}
```

## Data Mapping for Hevier

### Exercise Name to Muscle Group Mapping
```javascript
function mapHevyExerciseToMuscleGroups(exerciseTitle) {
  const name = exerciseTitle.toLowerCase();
  const muscleGroups = [];
  
  // Use Hevy's muscle_groups from exercise templates when available
  // Fall back to pattern matching for unmapped exercises
  
  const patterns = {
    'CHEST': ['bench', 'chest', 'fly', 'pec', 'dip'],
    'BACK': ['row', 'pull', 'lat', 'pulldown', 'chin'],
    'SHOULDERS': ['shoulder', 'press', 'raise', 'lateral', 'rear delt'],
    'BICEPS': ['curl', 'bicep'],
    'TRICEPS': ['tricep', 'pushdown', 'extension', 'skull crusher'],
    'QUADS': ['squat', 'leg press', 'lunge', 'extension'],
    'HAMSTRINGS': ['deadlift', 'rdl', 'curl', 'good morning'],
    'GLUTES': ['hip thrust', 'glute', 'bridge'],
    'CALVES': ['calf', 'raise']
  };
  
  for (const [muscleGroup, keywords] of Object.entries(patterns)) {
    if (keywords.some(keyword => name.includes(keyword))) {
      muscleGroups.push(muscleGroup);
    }
  }
  
  return muscleGroups.length > 0 ? muscleGroups : ['CHEST']; // default
}
```

### Set Type Classification
```javascript
function classifyHevySet(set) {
  return {
    reps: set.reps || 0,
    weight: set.weight_kg,
    rpe: set.rpe,
    isWarmup: set.type === 'warmup',
    isDropSet: set.type === 'drop',
    isFailure: set.type === 'failure'
  };
}
```

## Testing Your Integration

### 1. API Connection Test
```bash
# Test your API key
curl -X GET "https://api.hevyapp.com/v1/user/profile" \
  -H "api-key: YOUR_TOKEN"
```

### 2. Webhook Test
```bash
# Test your webhook endpoint  
curl -X POST "http://localhost:3000/api/webhook/hevy" \
  -H "Content-Type: application/json" \
  -d '{"id":"test","payload":{"workoutId":"test-workout-123"}}'
```

### 3. Integration Test Script
```javascript
async function testHevyIntegration() {
  try {
    const client = new HevyClient(process.env.HEVY_API_TOKEN);
    
    // Test 1: Get user profile
    console.log('Testing user profile...');
    const profile = await client.getUserProfile();
    console.log('✅ Profile:', profile.username);
    
    // Test 2: Get recent workouts
    console.log('Testing workout fetch...');
    const workouts = await client.getWorkouts({ limit: 5 });
    console.log(`✅ Found ${workouts.length} recent workouts`);
    
    // Test 3: Search exercise templates
    console.log('Testing exercise search...');
    const templates = await client.getExerciseTemplates({ search: 'bench press' });
    console.log(`✅ Found ${templates.exercise_templates.length} exercise templates`);
    
    console.log('🎉 All tests passed!');
  } catch (error) {
    console.error('❌ Integration test failed:', error);
  }
}
```

## Hevier-Specific Implementation Notes

### Current Usage in Hevier
- **Primary**: `GET /v1/workouts` for historical analysis
- **Secondary**: `GET /v1/workouts/{id}` via webhook notifications
- **Future**: `POST /v1/workouts` for creating suggested workouts

### Webhook Payload Processing
```javascript
// In your webhook handler (/api/webhook/hevy/route.ts)
export async function POST(request) {
  const { id, payload } = await request.json();
  
  // Fetch the specific workout
  const workout = await client.getWorkout(payload.workoutId);
  
  // Convert to Hevier format and analyze
  const analysis = analyzer.analyzeWeeklyVolume([...existingWorkouts, workout]);
  
  return Response.json({ success: true, analysis });
}
```

---

## Resources

- **Official API Docs**: https://api.hevyapp.com/docs/
- **Hevy Client Library**: https://github.com/kuhiga/hevy-api-client
- **Hevier Webhook Endpoint**: `/api/webhook/hevy`
- **Rate Limits**: 1000 requests/hour, 50/minute burst

**Last Updated**: December 2024  
**API Version**: v1